# Deep-Live-Cam AI Guide
- **Project Scope**: Real-time face swap pipeline driven from `run.py` (CustomTkinter GUI + CLI), an Electron desktop shell (`desktop-app/main.js`), and optional FastAPI servers (`server.py`, `cloud-server/server.py`). Changes must keep these three surfaces interoperable.
- **Entry Points**: `run.py` calls `modules.core.run()`, which parses CLI/UI args then dispatches to `modules.core.start()`. Desktop builds still launch the same Python entry via packaged binaries, so guard any new flags behind `modules.core.parse_args`.
- **Global State Contract**: `modules/globals.py` is the single source of truth for runtime configuration (paths, feature flags, execution providers). Always update that module instead of ad-hoc globals, and keep `fp_ui` toggles in sync with new UI controls.
- **Frame Processor Interface**: Modules under `modules/processors/frame/` must expose `pre_check`, `pre_start`, `process_frame`, `process_image`, `process_video`. The orchestrator in `modules/processors/frame/core.py` enforces this and caches modules—touch `FRAME_PROCESSORS_MODULES` carefully to avoid stale state between runs.
- **Face Swap Flow**: `modules/processors/frame/face_swapper.py` loads InsightFace models from `models/`. `pre_check` auto-downloads ONNX assets; if you add models, ensure they stream through `conditional_download` and respect provider selection (`modules.core.decode_execution_providers`).
- **Mapping & Many-Face Modes**: When `map_faces` is enabled, `modules/face_analyser.py` populates `modules.globals.source_target_map` and `simple_map`. Any change to clustering should keep `cluster_analysis.find_cluster_centroids` + `find_closest_centroid` compatible and respect the UI-driven combos in `modules/ui.py`.
- **Media I/O**: `modules/utilities.py` wraps all ffmpeg/ffprobe calls. Keep new ffmpeg uses behind `run_ffmpeg` so logging and temp handling stay centralized. Temp assets live under `<target>/temp/<name>` and are cleaned by `clean_temp()` unless `keep_frames` is set.
- **Resource Guards**: GPU builds rely on `OMP_NUM_THREADS=1` (set in `modules/core.py`) and TensorFlow memory capping in `limit_resources()`. When extending CUDA/DirectML/CoreML logic, update `suggest_execution_providers()` / `suggest_execution_threads()` to avoid starving the UI thread.
- **UI Layer**: `modules/ui.py` uses CustomTkinter with locale strings from `locales/*.json`. New UI elements should pull copy from those locale files and drive behavior via the globals module rather than direct state.
- **Desktop Shell**: Electron entry (`desktop-app/main.js`) loads static HTML from `local-client/`. IPC bridges for virtual camera live in `desktop-app/virtual-camera*.js`; keep renderer preload scripts (`preload*.js`) isolated from Node APIs and mirror any new IPC method across both classic and optimized implementations.
- **Server Modes**: `server.py` (headless local) and `cloud-server/server.py` (deployable) both pin `modules.globals.execution_providers` to CPU by default and stream frames over WebSockets. Reuse `processing_params` dict for tunables so desktop and cloud clients stay aligned.
- **Testing & Demos**: `test_separation.py` spins up `cloud-server/server.py` and launches `local-client/client.html` for manual verification. Follow `CONTRIBUTING.md` checklists—particularly GPU stress and camera enumeration—before promoting to `main`.
- **Env & Dependencies**: `requirements.txt` assumes Python 3.11+ with ffmpeg accessible in PATH. GPU acceleration needs CUDA 12.8 + cuDNN 8.9.7 and pins `onnxruntime-gpu==1.21.0`; DirectML/CoreML/OpenVINO variants require swapping that package via the documented commands in `README.md`.
- **Models Folder**: Keep large assets in `models/` with the names expected by the code (`inswapper_128.onnx`, `GFPGANv1.4.pth`). Prefer incremental downloads through Hugging Face URLs already referenced to avoid bloating the repo.
- **Type Discipline**: Mypy runs with `mypi.ini` (strict + `ignore_missing_imports`). Add annotations for new public functions, update `modules/typing.py` if you introduce reusable numpy aliases, and run `mypy modules/` locally before submitting.
- **Build Scripts**: Desktop builds rely on `package.json` and `electron-builder`; keep `files` globs in sync if you add preload assets. Python packaging scripts (`start-desktop.bat`, `run-*.bat`) assume repo root relative paths—avoid relocating entry scripts without updating them.
- **Streaming Diagnostics**: The repo ships with `debug-streaming-flow.js`, `diagnose-stream-interruption.js`, and HTML test harnesses under `/test-*`. Extend these rather than creating ad-hoc debug scripts so the desktop QA team can reuse them.
- **Security & Filters**: NSFW filtering toggles live in `modules/utilities` + `modules/core` flags; if adding new content filters, expose them via CLI args and the UI toggles so automated ethics checks remain functional.
- **Deployment**: Cloud scripts in `cloud-server/deploy*.sh` target Ubuntu-based GPU instances; any change to server dependencies must also update `cloud-server/requirements.txt` to prevent drift from `start_server.py`’s install check.
- **Logging**: User-visible status goes through `modules.core.update_status()` to mirror CLI and GUI output. Avoid `print` for persistent messages—wrap them so the UI receives updates.
- **Performance Metrics**: Electron preload scripts expect periodic stats from `/verify-streaming.js` and the optimized virtual camera pipeline. Ensure new streaming endpoints surface FPS/latency similar to `desktop-app/stream-server.js`’s `frameStats` object.
- **Before You Ship**: Manual GPU test: `python run.py --execution-provider cuda` with and without `--keep-fps`; CPU regression: `python run.py -s sample.jpg -t sample.mp4 --keep-audio`; server sanity: `python start_server.py` then hit `http://localhost:8000`. Update docs in `README.md`, `STREAMING_GUIDE.md`, or `DESKTOP-APP-SUMMARY.md` if workflows change.
